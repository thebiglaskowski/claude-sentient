{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://claude-conductor.dev/schemas/gate.schema.json",
  "title": "Quality Gate Definition",
  "description": "Schema for modular quality gates",
  "allOf": [
    { "$ref": "base.schema.json" }
  ],
  "type": "object",
  "required": ["category", "check"],
  "properties": {
    "category": {
      "type": "string",
      "enum": ["code", "work", "custom"],
      "description": "Gate category"
    },
    "blocking": {
      "type": "boolean",
      "default": true,
      "description": "Whether failure blocks progress"
    },
    "order": {
      "type": "integer",
      "minimum": 1,
      "maximum": 100,
      "description": "Execution order within category"
    },
    "check": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["command", "file", "metric", "expression", "custom"],
          "description": "How to check the gate"
        },
        "command": {
          "type": "string",
          "description": "Shell command to run (for type: command)"
        },
        "file": {
          "type": "string",
          "description": "File to check existence/content (for type: file)"
        },
        "metric": {
          "type": "string",
          "description": "Metric name from state (for type: metric)"
        },
        "expression": {
          "type": "string",
          "description": "JSONPath or expression to evaluate"
        },
        "threshold": {
          "description": "Value to compare against"
        },
        "operator": {
          "type": "string",
          "enum": ["eq", "ne", "gt", "gte", "lt", "lte", "contains", "matches", "exists"],
          "default": "gte",
          "description": "Comparison operator"
        },
        "successExitCode": {
          "type": "integer",
          "default": 0,
          "description": "Exit code considered success (for type: command)"
        },
        "timeout": {
          "type": "integer",
          "default": 60000,
          "description": "Timeout in milliseconds"
        }
      },
      "required": ["type"]
    },
    "fix": {
      "type": "object",
      "properties": {
        "auto": {
          "type": "boolean",
          "default": false,
          "description": "Whether to attempt auto-fix"
        },
        "skill": {
          "type": "string",
          "description": "Skill to invoke for fixing"
        },
        "command": {
          "type": "string",
          "description": "Command to run for fixing"
        },
        "maxAttempts": {
          "type": "integer",
          "default": 3,
          "description": "Maximum fix attempts"
        }
      },
      "description": "Auto-fix configuration"
    },
    "severity": {
      "type": "string",
      "enum": ["S0", "S1", "S2", "S3"],
      "default": "S1",
      "description": "Severity level if gate fails"
    },
    "appliesTo": {
      "type": "array",
      "items": { "type": "string" },
      "description": "File glob patterns this gate applies to"
    },
    "skipWhen": {
      "type": "object",
      "properties": {
        "noChanges": { "type": "boolean" },
        "patterns": {
          "type": "array",
          "items": { "type": "string" }
        },
        "expression": { "type": "string" }
      },
      "description": "Conditions to skip this gate"
    },
    "message": {
      "type": "object",
      "properties": {
        "success": { "type": "string" },
        "failure": { "type": "string" },
        "skipped": { "type": "string" }
      },
      "description": "Custom messages for gate results"
    }
  }
}
