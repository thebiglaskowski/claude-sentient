{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://claude-conductor.dev/schemas/state.schema.json",
  "title": "Loop State",
  "description": "Schema for the structured loop state",
  "type": "object",
  "required": ["version", "sessionId", "iteration", "phase", "workQueue", "gates"],
  "properties": {
    "version": {
      "type": "string",
      "const": "2.0",
      "description": "State schema version"
    },
    "sessionId": {
      "type": "string",
      "format": "uuid",
      "description": "Unique session identifier"
    },
    "startedAt": {
      "type": "string",
      "format": "date-time",
      "description": "Session start timestamp"
    },
    "iteration": {
      "type": "integer",
      "minimum": 0,
      "description": "Current iteration number"
    },
    "phase": {
      "type": "string",
      "enum": ["classify", "contextualize", "assess", "plan", "execute", "verify", "quality", "checkpoint", "evaluate", "recover"],
      "description": "Current phase"
    },
    "status": {
      "type": "string",
      "enum": ["running", "paused", "complete", "failed"],
      "default": "running",
      "description": "Overall loop status"
    },
    "classification": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["depth-first", "breadth-first", "straightforward"]
        },
        "complexity": {
          "type": "string",
          "enum": ["simple", "medium", "complex"]
        },
        "subagentCount": {
          "type": "integer",
          "minimum": 0,
          "maximum": 20
        },
        "orchestrationMode": {
          "type": "string",
          "enum": ["standard", "swarm", "pipeline"]
        }
      },
      "description": "Task classification results"
    },
    "workQueue": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "priority": { "type": "string", "enum": ["S0", "S1", "S2", "S3"] },
          "title": { "type": "string" },
          "description": { "type": "string" },
          "status": {
            "type": "string",
            "enum": ["pending", "in-progress", "blocked", "done", "failed", "cancelled"]
          },
          "blockedBy": {
            "type": "array",
            "items": { "type": "string" }
          },
          "blocks": {
            "type": "array",
            "items": { "type": "string" }
          },
          "assignedTo": { "type": "string" },
          "createdAt": { "type": "string", "format": "date-time" },
          "updatedAt": { "type": "string", "format": "date-time" },
          "completedAt": { "type": "string", "format": "date-time" }
        },
        "required": ["id", "priority", "title", "status"]
      },
      "description": "Work queue with tasks"
    },
    "gates": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": ["pending", "running", "passed", "failed", "skipped"]
          },
          "lastCheck": { "type": "string", "format": "date-time" },
          "value": {},
          "threshold": {},
          "attempts": { "type": "integer" },
          "error": { "type": "string" },
          "duration": { "type": "integer" }
        }
      },
      "description": "Quality gate states"
    },
    "context": {
      "type": "object",
      "properties": {
        "budgetUsed": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "level": {
          "type": "string",
          "enum": ["green", "yellow", "orange", "red"]
        },
        "compactionReady": { "type": "boolean" },
        "lastCompaction": { "type": "string", "format": "date-time" },
        "tokensUsed": { "type": "integer" },
        "tokensAvailable": { "type": "integer" }
      },
      "description": "Context budget state"
    },
    "agents": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "type": { "type": "string" },
          "status": { "type": "string", "enum": ["running", "complete", "failed"] },
          "task": { "type": "string" },
          "startedAt": { "type": "string", "format": "date-time" },
          "completedAt": { "type": "string", "format": "date-time" }
        }
      },
      "description": "Spawned agents"
    },
    "metrics": {
      "type": "object",
      "properties": {
        "iterationsTotal": { "type": "integer" },
        "gatesPassed": { "type": "integer" },
        "gatesFailed": { "type": "integer" },
        "tasksCompleted": { "type": "integer" },
        "pivotsCount": { "type": "integer" },
        "agentsSpawned": { "type": "integer" },
        "duration": { "type": "integer" },
        "tokensUsed": { "type": "integer" }
      },
      "description": "Session metrics"
    },
    "history": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "iteration": { "type": "integer" },
          "phase": { "type": "string" },
          "action": { "type": "string" },
          "result": { "type": "string" },
          "timestamp": { "type": "string", "format": "date-time" },
          "details": { "type": "object" }
        }
      },
      "description": "Action history for debugging"
    },
    "decisions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "category": {
            "type": "string",
            "enum": ["TECH", "ARCH", "TRADE", "SCOPE", "SEC", "PERF", "FIX", "DEFER"]
          },
          "decision": { "type": "string" },
          "rationale": { "type": "string" },
          "alternatives": { "type": "array", "items": { "type": "string" } },
          "timestamp": { "type": "string", "format": "date-time" }
        }
      },
      "description": "Logged decisions for traceability"
    }
  }
}
